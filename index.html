<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>RUTOX UNIVERSE</title>

  <!-- Favicon emoji universo -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E%F0%9F%8C%8C%3C/text%3E%3C/svg%3E">

  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

  <style>
    :root {
      --bg: #020617;
      --glass: rgba(255,255,255,0.08);
      --border: rgba(255,255,255,0.15);
      --neon: #00f2ff;
      --primary: #6366f1;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Plus Jakarta Sans', sans-serif;
      color: white;
      background: radial-gradient(circle at 50% 50%, #0f172a 0%, #020617 100%);
      background-attachment: fixed;
    }

    /* ---------- LOBBY ---------- */
    #lobby {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      gap: 20px;
      padding: 10px 30px 30px 30px;
    }

    .app {
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: 25px;
      height: 98px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: 0.3s;
    }

    .app:hover {
      transform: scale(1.05);
      background: rgba(255,255,255,0.15);
    }

    .app span {
      margin-top: 6px;
      font-size: 0.8rem;
      font-weight: 700;
    }

    .app-icon { font-size: 1.8rem; }

    /* ---------- SECCIONES ---------- */
    .section { display: none; padding: 20px; }

    .back {
      margin-bottom: 20px;
      background: none;
      border: none;
      color: var(--neon);
      font-size: 1rem;
      cursor: pointer;
    }

    /* ---------- COM√öN ---------- */
    .container { max-width: 1200px; margin: auto; }

    .title {
      font-size: 4rem;
      font-weight: 800;
      text-align: center;
      margin: 0 0 20px 0;
      background: linear-gradient(90deg, #fff, var(--neon));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .controls-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin-bottom: 40px;
      flex-wrap: wrap;
    }

    .total-badge {
      background: rgba(255, 255, 255, 0.05);
      padding: 10px 30px;
      border-radius: 100px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--neon);
      backdrop-filter: blur(10px);
    }

    .order-btn, .filter-btn {
      background: rgba(255,255,255,0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 10px 16px;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 700;
      transition: 0.3s;
      font-size: 0.9rem;
    }

    .order-btn:hover, .filter-btn:hover {
      background: rgba(255,255,255,0.15);
      border-color: rgba(255,255,255,0.2);
    }

    .filter-btn.active {
      background: var(--primary);
      border-color: var(--primary);
    }

    .admin-panel {
      background: rgba(15, 23, 42, 0.9);
      padding: 30px;
      border-radius: 30px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 60px;
      position: relative;
      z-index: 100;
    }

    .grid-inputs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    input {
      background: #000;
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 15px;
      color: white;
      font-size: 1rem;
      width: 100%;
    }

    .btn-main {
      background: white;
      color: black;
      border: none;
      padding: 18px;
      border-radius: 15px;
      font-weight: 800;
      cursor: pointer;
      width: 100%;
      font-size: 1.1rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 30px;
    }

    .card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 30px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 20px;
      position: relative;
      transform-style: preserve-3d;
      transition: 0.25s;
    }

    .card.checked {
      border-color: rgba(0, 242, 255, 0.6);
      box-shadow: 0 0 0 1px rgba(0, 242, 255, 0.25);
      opacity: 0.92;
    }

    .card img {
      width: 100%;
      height: 220px;
      object-fit: cover;
      border-radius: 20px;
      margin-bottom: 15px;
      pointer-events: none;
    }

    .card-name {
      font-weight: 800;
      font-size: 1.3rem;
      margin-bottom: 5px;
      color: #fff;
    }

    .card-price {
      font-size: 2rem;
      font-weight: 800;
      color: var(--neon);
      margin-bottom: 15px;
    }

    .card-actions {
      position: absolute;
      top: 15px;
      right: 15px;
      display: flex;
      gap: 8px;
      z-index: 50;
    }

    .circle-btn {
      width: 38px;
      height: 38px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background: rgba(0,0,0,0.7);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    .btn-link {
      display: block;
      text-align: center;
      padding: 12px;
      border-radius: 12px;
      background: rgba(255,255,255,0.05);
      color: var(--neon);
      text-decoration: none;
      font-weight: 700;
      font-size: 0.8rem;
    }

    /* ---------- MEDIA ---------- */
    .media-sub {
      text-align: center;
      opacity: 0.85;
      margin-top: 10px;
      margin-bottom: 30px;
      font-weight: 600;
    }
    .hint { text-align: center; font-weight: 700; opacity: 0.85; }
    .warning {
      text-align: center;
      margin-top: 10px;
      font-weight: 800;
      color: var(--neon);
      opacity: 0.95;
    }
    .exam-row { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }

    .btn-secondary {
      background: rgba(255,255,255,0.08);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.12);
      padding: 18px;
      border-radius: 15px;
      font-weight: 800;
      cursor: pointer;
      flex: 1;
      min-width: 180px;
      transition: 0.3s;
    }
    .btn-secondary:hover { background: rgba(255,255,255,0.15); }

    .exam-meta {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .pill {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      font-weight: 800;
      font-size: 0.9rem;
    }
    .big-grade {
      font-size: 2.2rem;
      font-weight: 900;
      color: var(--neon);
      margin-top: 12px;
    }
    .muted { opacity: 0.8; font-weight: 700; }
    .soft-note {
      text-align: center;
      opacity: 0.85;
      font-weight: 700;
      margin-top: 10px;
    }

    /* ---------- BOT√ìN COMPARTIR (solo lobby) ---------- */
    #shareFab {
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 9999;
      width: 56px;
      height: 56px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0, 0, 0, 0.55);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(12px);
      transition: 0.25s;
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
      font-size: 1.2rem;
    }
    #shareFab:hover {
      transform: translateY(-2px);
      border-color: rgba(0,242,255,0.45);
      box-shadow: 0 12px 34px rgba(0,0,0,0.45), 0 0 0 1px rgba(0,242,255,0.18);
    }

    /* ---------- WIDGET TIEMPO (arriba derecha, solo lobby) ---------- */
    #wxTop {
      position: fixed;
      top: 18px;
      right: 18px;
      z-index: 9999;
      padding: 10px 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0, 0, 0, 0.55);
      backdrop-filter: blur(12px);
      cursor: pointer;
      transition: 0.25s;
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
      min-width: 92px;
      user-select: none;
    }
    #wxTop:hover {
      transform: translateY(-2px);
      border-color: rgba(0,242,255,0.45);
      box-shadow: 0 12px 34px rgba(0,0,0,0.45), 0 0 0 1px rgba(0,242,255,0.18);
    }
    #wxTopMain { font-weight: 900; font-size: 1rem; }
    #wxTopSub  { font-weight: 800; font-size: 0.72rem; color: var(--neon); opacity: 0.92; max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  </style>
</head>

<body>

  <!-- T√çTULO -->
  <div class="container" style="padding: 28px 30px 0 30px;">
    <h1 class="title" data-aos="fade-down" style="margin-bottom: 18px;">RUTOX UNIVERSE</h1>
  </div>

  <!-- LOBBY -->
  <div id="lobby">
    <div class="app" onclick="openSection('wishlist')">
      <div class="app-icon">üß†</div>
      <span>Wishlist</span>
    </div>

    <div class="app" onclick="openSection('media')">
      <div class="app-icon">üìö</div>
      <span>Media</span>
    </div>

    <div class="app">
      <div class="app-icon">üöß</div>
      <span>Pr√≥ximamente</span>
    </div>
  </div>

  <!-- WIDGET TIEMPO (solo lobby) -->
  <div id="wxTop" onclick="wxConfigure()" title="Click para cambiar ciudad / usar ubicaci√≥n">
    <div id="wxTopMain">‚Äî</div>
    <div id="wxTopSub">Pulsa para elegir</div>
  </div>

  <!-- BOT√ìN COMPARTIR (solo lobby) -->
  <button id="shareFab" onclick="shareSite()" aria-label="Compartir web" title="Compartir">üîó</button>

  <!-- WISHLIST -->
  <div id="wishlist" class="section">
    <button class="back" onclick="goHome()">‚Üê Volver</button>

    <div class="container">
      <h1 class="title" data-aos="fade-down">Wishlist</h1>

      <div class="controls-row" data-aos="fade-up">
        <div class="total-badge" id="totalPrice">0.00 ‚Ç¨</div>
        <button class="order-btn" onclick="toggleOrden()">‚áÖ Ordenar por Precio</button>

        <button id="fAll" class="filter-btn active" onclick="setFiltro('all')">Todos</button>
        <button id="fChecked" class="filter-btn" onclick="setFiltro('checked')">Marcados</button>
        <button id="fUnchecked" class="filter-btn" onclick="setFiltro('unchecked')">Sin marcar</button>
      </div>

      <div class="admin-panel" data-aos="fade-up">
        <div class="grid-inputs">
          <input id="name" type="text" placeholder="¬øQu√© es?">
          <input id="price" type="number" step="0.01" placeholder="Precio (‚Ç¨)">
          <input id="link" placeholder="URL Producto">
          <input id="image" placeholder="URL Imagen">
        </div>

        <div style="display: flex; gap: 10px; margin-top: 15px;">
          <input id="pass" type="password" placeholder="Pass" style="width: 140px;">
          <button id="saveBtn" class="btn-main" onclick="guardar()">GUARDAR</button>
        </div>

        <input type="hidden" id="editId">
      </div>

      <div id="wishlistNote" class="soft-note" style="display:none;"></div>
      <div id="productContainer" class="grid"></div>
    </div>
  </div>

  <!-- MEDIA -->
  <div id="media" class="section">
    <button class="back" onclick="goHome()">‚Üê Volver</button>

    <div class="container">
      <h1 class="title" data-aos="fade-down">Media</h1>
      <div class="media-sub" data-aos="fade-up">
        Calcula tu <b>media ponderada</b> seg√∫n el porcentaje de cada examen.
      </div>

      <div class="controls-row" data-aos="fade-up">
        <div class="total-badge" id="weightedAvg">--</div>
        <div class="total-badge" id="weightTotal">0%</div>
      </div>

      <div class="hint muted" data-aos="fade-up">
        Media = (Œ£ nota √ó peso) / (Œ£ peso) ¬∑ m√≠nimo 2 ex√°menes
      </div>
      <div class="warning" id="weightWarning" style="display:none;"></div>

      <div class="admin-panel" data-aos="fade-up">
        <div class="grid-inputs">
          <input id="examName" type="text" placeholder="Nombre (opcional)">
          <input id="examGrade" type="number" step="0.01" placeholder="Nota (0‚Äì10)">
          <input id="examWeight" type="number" step="0.01" placeholder="Peso (%) (p. ej. 30)">
        </div>

        <div class="exam-row">
          <button id="examSaveBtn" class="btn-main" onclick="addOrUpdateExam()">A√ëADIR</button>
          <button class="btn-secondary" onclick="resetExams()">RESET</button>
        </div>

        <input type="hidden" id="examEditIndex" value="">
      </div>

      <div id="examContainer" class="grid"></div>
    </div>
  </div>

  <!-- LIBRER√çAS -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.7.0/vanilla-tilt.min.js"></script>

  <script>
    AOS.init({ duration: 800 });

    // ---------- Navegaci√≥n ----------
    function openSection(id) {
      document.getElementById("lobby").style.display = "none";
      document.getElementById("shareFab").style.display = "none";
      document.getElementById("wxTop").style.display = "none";
      document.getElementById(id).style.display = "block";
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function goHome() {
      document.querySelectorAll(".section").forEach(s => s.style.display = "none");
      document.getElementById("lobby").style.display = "grid";
      document.getElementById("shareFab").style.display = "flex";
      document.getElementById("wxTop").style.display = "flex";
      window.scrollTo({ top: 0, behavior: "smooth" });

      wxAutoUpdate(); // ‚úÖ actualiza al volver al lobby
    }

    // ---------- Compartir ----------
    async function shareSite() {
      const url = window.location.href;
      const title = "RUTOX UNIVERSE";
      const text = "Mira mi web:";

      try {
        if (navigator.share) {
          await navigator.share({ title, text, url });
          return;
        }
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(url);
          alert("Enlace copiado ‚úÖ");
        } else {
          prompt("Copia el enlace:", url);
        }
      } catch (e) {
        console.log(e);
      }
    }

    // ---------- Helpers ----------
    function formatNum(n) { const x = Number(n); return Number.isNaN(x) ? "0.00" : x.toFixed(2); }
    function clamp(n, min, max) { return Math.min(max, Math.max(min, n)); }
    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // ============================================================
    // MEDIA
    // ============================================================
    const EXAMS_KEY = "aleix_exams_v1";
    let exams = [];

    function loadExams() {
      try {
        exams = JSON.parse(localStorage.getItem(EXAMS_KEY) || "[]");
        if (!Array.isArray(exams)) exams = [];
      } catch { exams = []; }
      renderExams();
      updateStats();
    }

    function saveExams() { localStorage.setItem(EXAMS_KEY, JSON.stringify(exams)); }

    function addOrUpdateExam() {
      const name = (document.getElementById("examName").value || "").trim();
      const gradeRaw = parseFloat(document.getElementById("examGrade").value);
      const weightRaw = parseFloat(document.getElementById("examWeight").value);

      if (Number.isNaN(gradeRaw)) return alert("Pon una nota v√°lida.");
      if (Number.isNaN(weightRaw)) return alert("Pon un peso (%) v√°lido.");

      const grade = clamp(gradeRaw, 0, 10);
      const weight = clamp(weightRaw, 0, 100);

      const idx = document.getElementById("examEditIndex").value;
      const payload = { name, grade, weight };

      if (idx !== "" && !Number.isNaN(parseInt(idx, 10))) exams[parseInt(idx, 10)] = payload;
      else exams.push(payload);

      saveExams();
      clearExamForm();
      renderExams();
      updateStats();
    }

    function editExam(index) {
      const e = exams[index]; if (!e) return;
      document.getElementById("examName").value = e.name || "";
      document.getElementById("examGrade").value = e.grade;
      document.getElementById("examWeight").value = e.weight;
      document.getElementById("examEditIndex").value = index;
      document.getElementById("examSaveBtn").innerText = "ACTUALIZAR";
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function deleteExam(index) {
      if (!exams[index]) return;
      exams.splice(index, 1);
      saveExams();
      renderExams();
      updateStats();
    }

    function clearExamForm() {
      document.getElementById("examName").value = "";
      document.getElementById("examGrade").value = "";
      document.getElementById("examWeight").value = "";
      document.getElementById("examEditIndex").value = "";
      document.getElementById("examSaveBtn").innerText = "A√ëADIR";
    }

    function resetExams() {
      if (!confirm("¬øSeguro que quieres borrar todos los ex√°menes?")) return;
      exams = [];
      saveExams();
      clearExamForm();
      renderExams();
      updateStats();
    }

    function renderExams() {
      const container = document.getElementById("examContainer");
      let html = "";
      exams.forEach((e, i) => {
        const title = (e.name && e.name.trim()) ? escapeHtml(e.name) : `Examen #${i + 1}`;
        html += `
          <div class="card" data-tilt data-tilt-max="8">
            <div class="card-actions">
              <button class="circle-btn" onclick="editExam(${i})">‚úèÔ∏è</button>
              <button class="circle-btn" style="background:rgba(255,0,0,0.5)" onclick="deleteExam(${i})">üóëÔ∏è</button>
            </div>

            <div class="card-name">${title}</div>

            <div class="exam-meta">
              <div class="pill">Peso: ${formatNum(e.weight)}%</div>
              <div class="pill">Aporta: ${formatNum((e.grade * e.weight) / 100)}</div>
            </div>

            <div class="big-grade">${formatNum(e.grade)}</div>
            <div class="muted">Nota</div>
          </div>
        `;
      });
      container.innerHTML = html;
      if (window.VanillaTilt) VanillaTilt.init(document.querySelectorAll("#examContainer .card"));
    }

    function updateStats() {
      const totalWeight = exams.reduce((acc, e) => acc + (parseFloat(e.weight) || 0), 0);
      const weightedSum = exams.reduce((acc, e) => acc + ((parseFloat(e.grade) || 0) * (parseFloat(e.weight) || 0)), 0);

      document.getElementById("weightTotal").innerText = formatNum(totalWeight) + "%";

      const warn = document.getElementById("weightWarning");
      warn.style.display = "block";

      if (exams.length < 2) {
        document.getElementById("weightedAvg").innerText = "--";
        warn.innerText = "A√±ade m√≠nimo 2 ex√°menes para calcular la media.";
        return;
      }

      const avg = totalWeight > 0 ? (weightedSum / totalWeight) : 0;
      document.getElementById("weightedAvg").innerText = formatNum(avg);

      const diff = 100 - totalWeight;
      if (Math.abs(diff) > 0.001) {
        warn.innerText = diff > 0
          ? `Te falta ${formatNum(diff)}% para llegar a 100%`
          : `Te sobra ${formatNum(-diff)}% (superas 100%)`;
      } else {
        warn.innerText = "Perfecto: el peso total suma 100% ‚úÖ";
      }
    }

    loadExams();

    // ============================================================
    // TIEMPO (widget arriba derecha, sin secci√≥n)
    // ============================================================
    const WX_LOC_KEY  = "rutox_weather_loc_v1";  // {type:'city'|'geo', label, lat, lon}
    const WX_LAST_KEY = "rutox_weather_last_v1"; // {main, sub, updatedAt}

    function wxEl(id){ return document.getElementById(id); }

    function wxSetTop(main, sub){
      wxEl("wxTopMain").innerText = main || "‚Äî";
      wxEl("wxTopSub").innerText = sub || "Pulsa para elegir";
      try {
        localStorage.setItem(WX_LAST_KEY, JSON.stringify({ main, sub, updatedAt: Date.now() }));
      } catch {}
    }

    function wxLoadLast(){
      try {
        const x = JSON.parse(localStorage.getItem(WX_LAST_KEY) || "null");
        if (x?.main || x?.sub) wxSetTop(x.main, x.sub);
      } catch {}
    }

    function wxSaveLoc(obj){ try { localStorage.setItem(WX_LOC_KEY, JSON.stringify(obj)); } catch {} }
    function wxGetLoc(){
      try {
        const x = JSON.parse(localStorage.getItem(WX_LOC_KEY) || "null");
        return x && typeof x === "object" ? x : null;
      } catch { return null; }
    }

    function wxEmoji(code){
      if (code === 0) return "‚òÄÔ∏è";
      if ([1,2,3].includes(code)) return "‚õÖ";
      if ([45,48].includes(code)) return "üå´Ô∏è";
      if ([51,53,55,56,57].includes(code)) return "üå¶Ô∏è";
      if ([61,63,65,66,67].includes(code)) return "üåßÔ∏è";
      if ([71,73,75,77].includes(code)) return "‚ùÑÔ∏è";
      if ([80,81,82].includes(code)) return "üåßÔ∏è";
      if ([95,96,99].includes(code)) return "‚õàÔ∏è";
      return "üå•Ô∏è";
    }

    async function wxFetchJson(url){
      const r = await fetch(url);
      if (!r.ok) throw new Error("Tiempo no disponible");
      return await r.json();
    }

    async function wxGeocodeCity(name){
      const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=1&language=es&format=json`;
      const data = await wxFetchJson(url);
      const hit = data?.results?.[0];
      if (!hit) return null;
      return {
        label: `${hit.name}${hit.admin1 ? ", " + hit.admin1 : ""}${hit.country ? ", " + hit.country : ""}`,
        lat: hit.latitude,
        lon: hit.longitude
      };
    }

    async function wxLoadByCoords(lat, lon, label, {save=true} = {}){
      const url =
        `https://api.open-meteo.com/v1/forecast` +
        `?latitude=${encodeURIComponent(lat)}` +
        `&longitude=${encodeURIComponent(lon)}` +
        `&current=temperature_2m,weather_code` +
        `&timezone=auto`;

      const data = await wxFetchJson(url);
      const c = data.current || {};
      const code = Number(c.weather_code);
      const temp = c.temperature_2m;

      const main = (temp == null) ? "‚Äî" : `${wxEmoji(code)} ${Math.round(Number(temp))}¬∞`;
      const sub  = label || "‚Äî";
      wxSetTop(main, sub);

      if (save) wxSaveLoc({ type:"city", label: sub, lat, lon });
    }

    async function wxSetCity(cityName){
      const hit = await wxGeocodeCity(cityName);
      if (!hit) { wxSetTop("‚Äî", "Ciudad no encontrada"); return; }
      await wxLoadByCoords(hit.lat, hit.lon, hit.label, {save:true});
    }

    function wxUseMyLocation(){
      if (!navigator.geolocation) { wxSetTop("‚Äî", "Sin geolocalizaci√≥n"); return; }
      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          wxSaveLoc({ type:"geo", label:"Mi ubicaci√≥n", lat, lon });
          await wxLoadByCoords(lat, lon, "Mi ubicaci√≥n", {save:false});
        },
        () => wxSetTop("‚Äî", "Permiso denegado")
      );
    }

    async function wxAutoUpdate(){
      try {
        const loc = wxGetLoc();
        if (loc && typeof loc.lat === "number" && typeof loc.lon === "number") {
          if (loc.type === "geo") {
            // no pedimos permiso autom√°tico en lobby, solo indicamos
            wxSetTop("üìç", "Pulsa para actualizar");
            return;
          }
          await wxLoadByCoords(loc.lat, loc.lon, loc.label, {save:false});
          return;
        }
        wxSetTop("‚Äî", "Pulsa para elegir");
      } catch {
        wxSetTop("‚Äî", "Pulsa para elegir");
      }
    }

    // click widget
    async function wxConfigure(){
      const city = prompt("Escribe una ciudad (ej: Barcelona)\n(o deja vac√≠o para usar tu ubicaci√≥n):", "");
      if (city === null) return;
      if (city.trim() === "") wxUseMyLocation();
      else await wxSetCity(city.trim());
    }

    // init
    wxLoadLast();
    wxAutoUpdate();

    // ============================================================
    // WISHLIST (Firebase) + filtros + tic
    // ============================================================
    let db = null;
    const PASS_KEY = "1234";
    let ordenAscendente = true;
    let filtro = "all";
    let lastSnap = null;

    function setFiltro(mode) {
      filtro = mode;
      document.getElementById("fAll").classList.toggle("active", mode === "all");
      document.getElementById("fChecked").classList.toggle("active", mode === "checked");
      document.getElementById("fUnchecked").classList.toggle("active", mode === "unchecked");
      if (lastSnap) renderizar(lastSnap);
    }

    function initWishlist() {
      try {
        const firebaseConfig = {
          apiKey: "AIzaSyBTobN1gD7fhXYiwH1w7dYQLWi3bFZoBjU",
          authDomain: "cosas-af46c.firebaseapp.com",
          projectId: "cosas-af46c",
          storageBucket: "cosas-af46c.firebasestorage.app",
          messagingSenderId: "145996030094",
          appId: "1:145996030094:web:2f8f38fdbde5d6d386e9df"
        };

        if (!window.firebase) throw new Error("Firebase no carg√≥");
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

        db = firebase.firestore();
        cargarProductos();
      } catch (e) {
        const note = document.getElementById("wishlistNote");
        note.style.display = "block";
        note.innerText = "Wishlist: no se pudo conectar a Firebase. (Media funciona).";
        console.error(e);
      }
    }

    function cargarProductos() {
      if (!db) return;
      db.collection("productos")
        .orderBy("price", ordenAscendente ? "asc" : "desc")
        .onSnapshot((snap) => {
          lastSnap = snap;
          renderizar(snap);
        });
    }

    function toggleOrden() {
      ordenAscendente = !ordenAscendente;
      cargarProductos();
    }

    function toggleMarcado(id, current) {
      if (!db) return;
      db.collection("productos").doc(id).update({ checked: !current });
    }

    function renderizar(snap) {
      const container = document.getElementById("productContainer");
      let html = "";
      let total = 0;
      let count = 1;

      snap.forEach((doc) => {
        const p = doc.data();
        const checked = !!p.checked;

        if (filtro === "checked" && !checked) return;
        if (filtro === "unchecked" && checked) return;

        total += parseFloat(p.price || 0);
        const name = p.name || `Objeto #${count}`;

        html += `
          <div class="card ${checked ? "checked" : ""}" data-tilt data-tilt-max="8">
            <div class="card-actions">
              <button class="circle-btn" title="Marcar" onclick="toggleMarcado('${doc.id}', ${checked})">
                ${checked ? "‚òëÔ∏è" : "‚¨ú"}
              </button>
              <button class="circle-btn" onclick="prepararEdicion('${doc.id}')">‚úèÔ∏è</button>
              <button class="circle-btn" style="background:rgba(255,0,0,0.5)" onclick="eliminar('${doc.id}')">üóëÔ∏è</button>
            </div>

            <img src="${p.image}" onerror="this.src='https://via.placeholder.com/400x300/020617/fff?text=Sin+Imagen'">
            <div class="card-name">${escapeHtml(name)}</div>
            <div class="card-price">${parseFloat(p.price || 0).toFixed(2)}‚Ç¨</div>
            <a href="${p.link}" target="_blank" class="btn-link">VER DETALLES</a>
          </div>
        `;
        count++;
      });

      container.innerHTML = html;
      document.getElementById("totalPrice").innerText = total.toFixed(2) + " ‚Ç¨";
      if (window.VanillaTilt) VanillaTilt.init(document.querySelectorAll("#productContainer .card"));
    }

    async function guardar() {
      if (!db) return alert("Firebase no est√° conectado.");
      if (document.getElementById("pass").value !== PASS_KEY) return alert("Pass incorrecto");

      const id = document.getElementById("editId").value;
      const data = {
        name: document.getElementById("name").value,
        price: parseFloat(document.getElementById("price").value) || 0,
        link: document.getElementById("link").value,
        image: document.getElementById("image").value
      };

      if (!id) data.checked = false;

      if (id) await db.collection("productos").doc(id).update(data);
      else await db.collection("productos").add(data);

      limpiar();
    }

    function prepararEdicion(id) {
      if (!db) return;
      db.collection("productos").doc(id).get().then(doc => {
        const p = doc.data();
        document.getElementById("name").value = p.name || "";
        document.getElementById("price").value = p.price || 0;
        document.getElementById("link").value = p.link || "";
        document.getElementById("image").value = p.image || "";
        document.getElementById("editId").value = id;
        document.getElementById("saveBtn").innerText = "ACTUALIZAR";
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    }

    function eliminar(id) {
      if (!db) return;
      if (prompt("Contrase√±a:") === PASS_KEY) db.collection("productos").doc(id).delete();
    }

    function limpiar() {
      ["name", "price", "link", "image", "pass", "editId"].forEach(i => document.getElementById(i).value = "");
      document.getElementById("saveBtn").innerText = "GUARDAR";
    }

    initWishlist();
  </script>
</body>
</html>
