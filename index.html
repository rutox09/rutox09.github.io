<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wishlist Pro - Aleix</title>
    <style>
        :root {
            --primary: #2ecc71;
            --secondary: #3498db;
            --danger: #e74c3c;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            margin: 0;
            padding: 20px;
            color: var(--dark);
        }

        .container {
            max-width: 900px;
            margin: auto;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: var(--shadow);
        }

        h2 { text-align: center; font-size: 2.5em; margin-bottom: 30px; color: var(--dark); }

        /* Controles de Orden y Admin */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
            flex-wrap: wrap;
        }

        select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
        }

        /* Panel de Edici√≥n/A√±adir */
        #adminPanel {
            background: var(--light);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: none;
            animation: fadeIn 0.5s;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 2fr 2fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            outline: none;
        }

        input:focus { border-color: var(--secondary); }

        /* Lista de Productos (Cards) */
        .product-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid #eee;
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
        }

        .card:hover { transform: translateY(-5px); box-shadow: var(--shadow); }

        .card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }

        .card-body { padding: 15px; text-align: center; }

        .price { font-size: 1.4em; font-weight: bold; color: var(--primary); margin: 10px 0; }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-main { background: var(--primary); color: white; width: 100%; }
        .btn-outline { background: var(--secondary); color: white; margin-top: 10px; font-size: 0.8em; }
        .btn-edit { background: #f1c40f; color: white; padding: 5px 10px; margin-right: 5px; }
        .btn-delete { background: var(--danger); color: white; padding: 5px 10px; }

        #totalPrice {
            text-align: center;
            font-size: 1.8em;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid var(--light);
        }

        /* Modal Login */
        #loginOverlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;
        }
        .login-box { background: white; padding: 30px; border-radius: 15px; width: 300px; text-align: center; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <h2>üõçÔ∏è Mi Lista de Deseos</h2>

    <div class="controls">
        <select id="sortOrder" onchange="renderizar()">
            <option value="recent">M√°s recientes</option>
            <option value="priceDesc">Precio: Mayor a Menor</option>
            <option value="priceAsc">Precio: Menor a Mayor</option>
        </select>
        <button id="loginBtn" class="btn btn-outline" onclick="abrirLogin()">Acceso Admin</button>
    </div>

    <div id="adminPanel">
        <h3 id="panelTitle">A√±adir Nuevo Producto</h3>
        <input type="hidden" id="editId">
        <div class="form-grid">
            <input id="price" type="number" step="0.01" placeholder="Precio ‚Ç¨">
            <input id="link" type="text" placeholder="URL del producto">
            <input id="image" type="text" placeholder="URL de la imagen">
        </div>
        <button id="saveBtn" class="btn btn-main" onclick="guardarProducto()">Guardar Producto</button>
        <button onclick="cerrarSesion()" class="btn btn-outline" style="background:#95a5a6; width:100%">Cerrar Sesi√≥n</button>
    </div>

    <div id="productContainer" class="product-list">
        </div>

    <div id="totalPrice">Total: 0.00 ‚Ç¨</div>
</div>

<div id="loginOverlay">
    <div class="login-box">
        <h3>Admin Login</h3>
        <input id="email" type="email" placeholder="Correo">
        <input id="pass" type="password" placeholder="Contrase√±a">
        <button onclick="login()" class="btn btn-main">Entrar</button>
        <button onclick="cerrarLogin()" style="background:none; border:none; color:gray; margin-top:10px; cursor:pointer;">Cancelar</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBTobN1gD7fhXYiwH1w7dYQLWi3bFZoBjU",
        authDomain: "cosas-af46c.firebaseapp.com",
        projectId: "cosas-af46c",
        storageBucket: "cosas-af46c.firebasestorage.app",
        messagingSenderId: "145996030094",
        appId: "1:145996030094:web:2f8f38fdbde5d6d386e9df"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    let productosLocales = [];

    // --- FUNCIONES DE AUTH ---
    function abrirLogin() { document.getElementById('loginOverlay').style.display = 'flex'; }
    function cerrarLogin() { document.getElementById('loginOverlay').style.display = 'none'; }
    function login() {
        const email = document.getElementById("email").value;
        const pass = document.getElementById("pass").value;
        auth.signInWithEmailAndPassword(email, pass).then(cerrarLogin).catch(() => alert("Error de acceso"));
    }
    function cerrarSesion() { auth.signOut(); }

    auth.onAuthStateChanged(user => {
        document.getElementById('adminPanel').style.display = user ? 'block' : 'none';
        document.getElementById('loginBtn').style.display = user ? 'none' : 'block';
        escucharProductos();
    });

    // --- GESTI√ìN DE PRODUCTOS ---
    function escucharProductos() {
        db.collection("productos").onSnapshot(snap => {
            productosLocales = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderizar();
        });
    }

    async function guardarProducto() {
        const id = document.getElementById("editId").value;
        const price = parseFloat(document.getElementById("price").value);
        const link = document.getElementById("link").value.trim();
        const image = document.getElementById("image").value.trim();

        if (!price || !link || !image) return alert("Completa todos los campos");

        // VALIDACI√ìN: No repetir enlaces
        const existe = productosLocales.find(p => p.link === link && p.id !== id);
        if (existe) return alert("Este enlace ya est√° en la lista.");

        const datos = { price, link, image, date: new Date() };

        if (id) {
            await db.collection("productos").doc(id).update(datos);
        } else {
            await db.collection("productos").add(datos);
        }
        
        // Limpiar form
        document.getElementById("editId").value = "";
        document.getElementById("price").value = "";
        document.getElementById("link").value = "";
        document.getElementById("image").value = "";
        document.getElementById("panelTitle").innerText = "A√±adir Nuevo Producto";
    }

    function editar(id) {
        const p = productosLocales.find(prod => prod.id === id);
        document.getElementById("editId").value = p.id;
        document.getElementById("price").value = p.price;
        document.getElementById("link").value = p.link;
        document.getElementById("image").value = p.image;
        document.getElementById("panelTitle").innerText = "Editando Producto";
        window.scrollTo(0, 0);
    }

    function borrar(id) {
        if (confirm("¬øSeguro que quieres eliminarlo?")) db.collection("productos").doc(id).delete();
    }

    function renderizar() {
        const container = document.getElementById("productContainer");
        const orden = document.getElementById("sortOrder").value;
        const isAdmin = auth.currentUser;

        // ORDENACI√ìN
        let lista = [...productosLocales];
        if (orden === "priceAsc") lista.sort((a, b) => a.price - b.price);
        if (orden === "priceDesc") lista.sort((a, b) => b.price - a.price);
        if (orden === "recent") lista.sort((a, b) => b.date - a.date);

        let html = "";
        let total = 0;

        lista.forEach(p => {
            total += p.price;
            html += `
                <div class="card">
                    <img src="${p.image}" onerror="this.src='https://via.placeholder.com/200?text=No+Image'">
                    <div class="card-body">
                        <div class="price">${p.price.toFixed(2)} ‚Ç¨</div>
                        <a href="${p.link}" target="_blank" class="btn btn-main">Ver Producto</a>
                        ${isAdmin ? `
                            <div style="margin-top:10px">
                                <button class="btn btn-edit" onclick="editar('${p.id}')">‚úèÔ∏è</button>
                                <button class="btn btn-delete" onclick="borrar('${p.id}')">üóëÔ∏è</button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
        document.getElementById("totalPrice").innerText = `Total acumulado: ${total.toFixed(2)} ‚Ç¨`;
    }
</script>
</body>
</html>
